#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Function:
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel_haze@hotmail.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Enables/disables internal Bt and Wifi on the RPi 3.
	#
	# Usage:
	# - /DietPi/dietpi/func/dietpi-set_rpi3_wifi_bt sADAPTER iSTATE
	#////////////////////////////////////

	#Force en_GB Locale for whole script. Prevents incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)

	if (( $HW_MODEL != 3 )); then
		echo -e "This script only supports RPi 3 devices"
		exit
	fi

	ADAPTER=$(echo -e "$1" | tr '[:upper:]' '[:lower:]') # bluetooth/wifi
	STATE=$2 # 0=disable | 1=enable

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#-----------------------------------------------------------------------------------
	if [ "$ADAPTER" = "wifi" ]; then

		# - Disable
		if (( ! $STATE )); then

			if [ ! -f /etc/modprobe.d/disable_rpi3_wifi.conf ]; then

				cat << _EOF_ > /etc/modprobe.d/disable_rpi3_wifi.conf
blacklist brcmfmac
blacklist brcmutil
_EOF_
				modprobe -rf brcmfmac
				modprobe -rf brcmutil

			fi

		# - Enable
		else

			if [ -f /etc/modprobe.d/disable_rpi3_wifi.conf ]; then

				rm /etc/modprobe.d/disable_rpi3_wifi.conf
				modprobe brcmfmac
				modprobe brcmutil

			fi

		fi

	#-----------------------------------------------------------------------------------
	elif [ "$ADAPTER" = "bluetooth" ]; then

		# - Disable
		if (( ! $STATE )); then

			if [ ! -f /etc/modprobe.d/disable_rpi3_bt.conf ]; then

				systemctl stop bluetooth
				systemctl stop hciuart

				systemctl disable bluetooth
				systemctl disable hciuart

				modprobe -rf bnep
				modprobe -rf hci_uart
				modprobe -rf btbcm
				modprobe -rf bluetooth

				cat << _EOF_ > /etc/modprobe.d/disable_rpi3_bt.conf
blacklist bnep
blacklist hci_uart
blacklist btbcm
blacklist bluetooth
_EOF_

		fi

		# - Enable
		else

			if [ -f /etc/modprobe.d/disable_rpi3_bt.conf ]; then

				modprobe bnep
				modprobe hci_uart
				modprobe btbcm
				modprobe bluetooth

				systemctl enable bluetooth
				systemctl enable hciuart

				systemctl start bluetooth
				systemctl start hciuart

				rm /etc/modprobe.d/disable_rpi3_bt.conf

			fi

		fi

	fi


	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}
