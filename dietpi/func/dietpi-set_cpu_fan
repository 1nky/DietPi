#!/bin/bash
{
	#////////////////////////////////////
	# DietPi CPU fan PWM script
	#
	#////////////////////////////////////
	# Created by Micha Felle / micha@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Location: /DietPi/dietpi/func/dietpi-set_cpu_fan + /boot/dietpi/func/dietpi-set_cpu_fan
	# - Runs at boot up /DietPi/dietpi/boot
	# - Toggles CPU fan temp control and:
	#	- Sets temp strip points, e.g. 35°C, 50°C, 65°C
	#	- Attaches PWM fan speeds to temp strip points, e.g. 0%, 45%, 70%, 95%
	#	or
	#	- Sets constant fan speed
	#////////////////////////////////////

	#Import DietPi-Globals ---------------------------------------------------------------
	. /DietPi/dietpi/func/dietpi-globals
	export G_PROGRAM_NAME='DietPi-Set_CPU_fan'
	G_INIT
	G_CHECK_ROOT_USER
	#Import DietPi-Globals ---------------------------------------------------------------

	#Exit path for VM
	if (( $G_HW_MODEL == 20 )); then

		G_DIETPI-NOTIFY 2 'CPU fan control is not available on VMs.'
		exit

	fi

	#Control file paths
	FP_SETTINGS='/DietPi/dietpi/.dietpi-set_cpu_fan'
	FP_FAN_CONTROL_TOGGLE='/sys/devices/platform/pwm-fan/hwmon/hwmon0/automatic'
	FP_FAN_TRIP_TEMPS='/sys/devices/virtual/thermal/thermal_zone0/trip_point_0_temp'
	FP_FAN_TRIP_SPEEDS='/sys/devices/platform/pwm-fan/hwmon/hwmon0/fan_speed'
	FP_FAN_SPEED_FIXED='/sys/devices/platform/pwm-fan/hwmon/hwmon0/pwm1'

	#Exit without settings or control toggle file
	if [[ ! -f $FP_SETTINGS ]]; then

		G_DIETPI-NOTIFY 2 'No settings file found, keep system defaults'
		exit

	elif [[ ! -e $FP_FAN_CONTROL_TOGGLE ]]; then

		G_DIETPI-NOTIFY 2 'CPU fan PWM control is not available on your system.'
		exit

	fi

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#-----------------------------------------------------------------------------------
	G_DIETPI-NOTIFY 3 $G_PROGRAM_NAME 'Applying CPU fan PWN settings'
	#-----------------------------------------------------------------------------------
	#Read settings file
	# - $FAN_CONTROL_TOGGLE=0|1; On|Off
	# - $FAN_TRIP_TEMPS='XX YY ZZ'; XX°C YY°C ZZ°C
	# - $FAN_TRIP_SPEEDS='AAA BBB CCC DDD'; AAA*100/255 %...
	# - $FAN_SPEED_FIXED=EEE; EEE*100/255 %
	. $FP_SETTINGS

	#Exit without control files, needed for chosen settings
	if (( $FAN_CONTROL_TOGGLE )) && [[ ! -e $FP_FAN_TRIP_TEMPS || ! -e $FP_FAN_TRIP_SPEEDS ]]; then

		G_DIETPI-NOTIFY 2 'Temperature based CPU fan PWM control is not available on your system.'
		exit

	elif (( ! $FAN_CONTROL_TOGGLE )) && [[ ! -e $FP_FAN_SPEED_FIXED ]]; then

		G_DIETPI-NOTIFY 2 'Changing constant CPU fan speed is not available on your system.'
		exit

	fi

	#Apply chosen settings
	if (( $FAN_CONTROL_TOGGLE )); then

		# Exit without control files files or empty settings strings
		if [[ ! -e $FP_FAN_TRIP_TEMPS || ! -e $FP_FAN_TRIP_SPEEDS ||
			-z $FAN_TRIP_TEMPS || -z $FAN_TRIP_SPEEDS ]]; then

			G_DIETPI-NOTIFY 2 'Temperature based CPU fan PWM control not chosen or not available on your system.'
			exit

		fi

		local i=0
		for (( i=0; i<$G_HW_CPU_CORES; i++ ))
		do

			local fp_target=''
			local j=0
			for fp_target in /sys/devices/virtual/thermal/thermal_zone$i/trip_point_*_temp
			do

				awk '{print $((j+1))}' <<< $FAN_TRIP_TEMPS > /sys/devices/virtual/thermal/thermal_zone$i/trip_point_$j_temp
				((j++))

			done

		done

		echo $FAN_TRIP_SPEEDS > $FP_FAN_TRIP_SPEEDS

	else

		# Exit without needed control file or empty settings string
		if [[ ! -e $FP_FAN_SPEED_FIXED || -z $FAN_SPEED_FIXED ]]; then

			G_DIETPI-NOTIFY 2 'Changing constant CPU fan speed not chosen or not available on your system.'
			exit

		fi

		echo $FAN_SPEED_FIXED > $FP_FAN_SPEED_FIXED

	fi

	echo $FAN_CONTROL_TOGGLE > $FP_FAN_CONTROL_TOGGLE

	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}
