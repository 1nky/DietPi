#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Function:
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel_haze@hotmail.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Allows automated moving of dietpi_userdata directory. Automatically generates a symlink from dietpi_userdata to target directory if needed.
	# - Also moves the Dphys swapfile to $TARGET_DIRECTORY. Required to prevent locked .swapfile from allow us to delete $SOURCE_DIRECTORY.
	#
	# Usage:
	# - /DietPi/dietpi/func/dietpi-move_userdata sTARGET_DIRECTORY
	#////////////////////////////////////

	#Force en_GB Locale for whole script. Prevents incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	TEMP_DIRECTORY='/mnt/dietpi_moveuserdata_tmp'
	DIETPI_USERDATA_DIRECTORY='/mnt/dietpi_userdata'

	SOURCE_DIRECTORY=$DIETPI_USERDATA_DIRECTORY
	TARGET_DIRECTORY="$1"

	SWAPFILE_SIZE=$(/DietPi/dietpi/func/dietpi-set_dphys-swapfile | awk '{print $1}')

	EXIT_CODE=0

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////

	#-------------------------------------------------------------------------------------
	if [ -d "$SOURCE_DIRECTORY" ]; then

		# - stop all running services.
		/DietPi/dietpi/dietpi-services stop

		# - move swap out the way
		/DietPi/dietpi/func/dietpi-set_dphys-swapfile 0 /mnt/.swapfile

		# - setup tmp dir
		rm -R "$TEMP_DIRECTORY" &> /dev/null
		mkdir -p "$TEMP_DIRECTORY"

		# - Copy source to tmp
		echo -e "\n DietPi is moving existing data from your $SOURCE_DIRECTORY to $TARGET_DIRECTORY. Please wait...\n"
		cp -R "$SOURCE_DIRECTORY"/* "$TEMP_DIRECTORY"/

		# - check for completion
		if (( $? == 0 )); then

			# - Remove all files in source, then its symlink (if it has one). Either way, all good.
			rm -R "$SOURCE_DIRECTORY"/*
			rm -R "$SOURCE_DIRECTORY"

			# - Generate target directory
			if [ "$TARGET_DIRECTORY" = "$DIETPI_USERDATA_DIRECTORY" ]; then
				rm -R "$TARGET_DIRECTORY" &> /dev/null
			fi
			mkdir -p "$TARGET_DIRECTORY" &> /dev/null

			# - Mv temp data over
			mv "$TEMP_DIRECTORY"/* "$TARGET_DIRECTORY"
			rm -R "$TEMP_DIRECTORY"

			# - Create symlink to DIETPI_USERDATA_DIRECTORY if required
			if [ "$TARGET_DIRECTORY" != "$DIETPI_USERDATA_DIRECTORY" ]; then

				rm -R "$DIETPI_USERDATA_DIRECTORY" &> /dev/null
				ln -sf "$TARGET_DIRECTORY" "$DIETPI_USERDATA_DIRECTORY"

			fi

			# - move swapfile
			/DietPi/dietpi/func/dietpi-set_dphys-swapfile "$SWAPFILE_SIZE" "$TARGET_DIRECTORY"/.swapfile

		else

			# - remove tmp folder
			rm -R "$TEMP_DIRECTORY"

			echo -e "ERROR: Failed to copy $SOURCE_DIRECTORY/* to $TEMP_DIRECTORY (tmp directory)."
			EXIT_CODE=1

		fi

	else

		echo -e "ERROR: $SOURCE_DIRECTORY does not exist."
		EXIT_CODE=2

	fi

	#-----------------------------------------------------------------------------------
	exit $EXIT_CODE
	#-----------------------------------------------------------------------------------
}
