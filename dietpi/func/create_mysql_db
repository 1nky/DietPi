#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Function:
	# - Creates a MySql database
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#////////////////////////////////////
	# Usage:
	# - /DietPi/dietpi/func/create_mysql_db DATABASE_NAME MYSQL_ROOT_PW DATABASE_USER DATABASE_PW
	#
	# Drop database:
	# - mysqladmin -u root -pdietpi drop phpbb3 -f
	#////////////////////////////////////

	DATABASE_NAME="$1"
	MYSQL_ROOT_PW="$2"
	DATABASE_USER="$3"
	DATABASE_PW="$4"

	#Import DietPi-Globals ---------------------------------------------------------------
	. /DietPi/dietpi/func/dietpi-globals
	G_CHECK_ROOT_USER
	export G_PROGRAM_NAME='DietPi-Create_MySQL_DB'
	#Import DietPi-Globals ---------------------------------------------------------------

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////

	#Start MySQL if not running.
	service mysql start &> /dev/null

	G_DIETPI-NOTIFY 2 "Creating MySQL database: $DATABASE_NAME"

	# On MariaDB, unix_socket authentication is used, thus no root password is necessary + it breaks access on Jessie.
	# If 'IDENTIFIED BY' is used on root user, it will overwrite unix_socket authentication, thus this part need to be left out on MariaDB.
	#Generate DB
	mysql_cmd='mysql -uroot'
	grep -q 'aSOFTWARE_INSTALL_STATE\[86\]=0' /DietPi/dietpi/.installed || mysql_cmd+=" -p$MYSQL_ROOT_PW"
	grant_privileges=''
	[ "$DATABASE_USER" == 'root' ] || grant_privileges="grant all privileges on \`$DATABASE_NAME\`.* to $DATABASE_USER@localhost identified by '$DATABASE_PW';flush privileges"
	$mysql_cmd -e "create database \`$DATABASE_NAME\`;$grant_privileges"

	G_DIETPI-NOTIFY -1 "$?" "Creating MySQL database: $DATABASE_NAME |"

	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}
