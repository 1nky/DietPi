#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Function:
	# - dietpi-apt-get_update
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Allows the running of apt-get update in background
	# - Uses $FILEPATH_STATEFILE which contains current state as value, 
	#   this can be used by other scripts to check apt-get update state.
	#
	# Usage:
	# - /tmp/dietpi/dietpi-apt-get_update    (starts a new update as another process, if $FILEPATH_STATEFILE is -2)
	# - /tmp/dietpi/dietpi-apt-get_update 1  (Blocking/check mode, starts apt-get update if it has never run, then, waits for a "done" state)
	# - /tmp/dietpi/dietpi-apt-get_update -1 (clears the state file if its not in use. New updates can then be run)
	#
	# Returns:
	# - $STATE_CURRENT   0 = apt-get update is running
	# - $STATE_CURRENT   1 = apt-get updated and completed
	# - $STATE_CURRENT  -1 = failed (error and/or warning)
	# - $STATE_CURRENT  -2 = apt-get update has never been run, and/or, ready to be run.
	#////////////////////////////////////

	INPUT=0
	if [[ $1 =~ ^-?[0-9]+$ ]]; then
		INPUT=$1
	fi
	
	#/////////////////////////////////////////////////////////////////////////////////////
	# Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	
	TEMP_FILE="/tmp/dietpi/apt_update_temp"
	FILEPATH_STATEFILE="/tmp/dietpi/.dietpi-apt-get_update"
	
	#-2 | Has never been run, and/or, ready to be run.
	#-1 | Failed to update
	# 0 | Updating now
	# 1 | Updated
	STATE_CURRENT=0
	
	Get_Current_State(){
	
		#apt-get update has not been run yet.
		if [ ! -f "$FILEPATH_STATEFILE" ]; then
			STATE_CURRENT=-2
			
		#Obtain state value from file
		else
			STATE_CURRENT=$(cat "$FILEPATH_STATEFILE")
		fi

	}
	
	Update_Apt(){
	
		#Run only if STATEFILE doesnt exist.
		if (( $STATE_CURRENT == -2 )); then

			# 0 = running
			STATE_CURRENT=0
			echo -e "$STATE_CURRENT" > "$FILEPATH_STATEFILE"

			#Update apt, output to temp file
			apt-get update > "$TEMP_FILE"

			#read temp file
			if (( $(cat "$TEMP_FILE" | grep -ci -m1 '[WE]: ') == 0 )); then
				#ok
				STATE_CURRENT=1
			else
				#failed
				STATE_CURRENT=-1
			fi
			
			#Update state file
			echo -e "$STATE_CURRENT" > "$FILEPATH_STATEFILE"

			#clean up
			rm "$TEMP_FILE"

		fi

	}
	
	Wait_For_Completion(){
	
		local text_info="Running, please wait..."
		
		Get_Current_State
		
		#Currently running
		while (( $STATE_CURRENT == 0 )); do

			/tmp/dietpi/dietpi-banner 0
			echo -e "\n Waiting for apt-get update to complete."
			echo -e "\n Status: | $text_info\n"
			/tmp/dietpi/dietpi-funtime
			
			Get_Current_State
		
		done
	
	}
	
	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	
	#Clear STATE file
	if (( $INPUT == -1 )); then

		Get_Current_State
		if (( $STATE_CURRENT != 0 )); then
			rm "$FILEPATH_STATEFILE"
			STATE_CURRENT=-2
		fi
		
	#Default input | Run update as another process.
	elif (( $INPUT == 0 )); then
	
		Get_Current_State
		Update_Apt &

	#Blocking mode
	elif (( $INPUT == 1 )); then
		
		Get_Current_State
		Update_Apt
		sleep 0.4
		
		#Wait / inform user
		Wait_For_Completion

	fi

	#-------------------------------------------------------------------------------------
	echo -e "$STATE_CURRENT"
	exit
	#-------------------------------------------------------------------------------------
}