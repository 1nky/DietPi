#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Function:
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel_haze@hotmail.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Enables/disables Wifi/BT modules. Also controls internal adapters on some devices (eg: RPI3)
	#
	# Usage:
	# - /DietPi/dietpi/func/dietpi-set_wifi_bt sADAPTER iSTATE
	#////////////////////////////////////

	#Force en_GB Locale for whole script. Prevents incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)

	ADAPTER=$(echo -e "$1" | tr '[:upper:]' '[:lower:]') # bluetooth/wifi
	STATE=$2 # 0=disable | 1=enable
	STATE_TEXT='Disable'
	if (( $STATE )); then
		STATE_TEXT='Enable'
	fi

	EXIT_CODE=0

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#-----------------------------------------------------------------------------------

	/DietPi/dietpi/func/dietpi-notify 3 DietPi "$STATE_TEXT $ADAPTER"

	#-----------------------------------------------------------------------------------
	#WiFi
	if [ "$ADAPTER" = "wifi" ]; then

		rm /etc/modprobe.d/disable_wifi.conf &> /dev/null

		aWIFI_MODULES=()

		# - All
		aWIFI_MODULES=("cfg80211")

		# + RPi 3
		aWIFI_MODULES+=("brcmfmac") #onboard WiFi
		aWIFI_MODULES+=("brcmutil") #oonboard WiFi

		# + Pine A64
		aWIFI_MODULES+=("8723bs") #addon WiFi/BT board.

		# + BPi Pro
		aWIFI_MODULES+=("ap6211") #onboard

		# - Disable
		if (( ! $STATE )); then

			#cfg80211 last
			for ((i=$(( ${#aWIFI_MODULES[@]} - 1 )); i>=0; i--))
			do
				modprobe -rf "${aWIFI_MODULES[$i]}" 2> /dev/null
				echo -e "blacklist ${aWIFI_MODULES[$i]}" >> /etc/modprobe.d/disable_wifi.conf
			done

		# - Enable
		else

			#cfg80211 first
			for ((i=0; i<${#aWIFI_MODULES[@]}; i++))
			do
				modprobe "${aWIFI_MODULES[$i]}" 2> /dev/null
			done

			# - Delay. Without this, kernel reports wifi device not found with RPi 3 and Pine A64 addon board, when ran straight after this script.
			echo -e "Please wait, enabling WiFi Modules..."
			sleep 3

			#Update our networking file (refresh active wlan index)
			/DietPi/dietpi/func/obtain_network_details

		fi

		unset aWIFI_MODULES

	#-----------------------------------------------------------------------------------
	#BT
	elif [ "$ADAPTER" = "bluetooth" ]; then

		rm /etc/modprobe.d/disable_bt.conf &> /dev/null

		aBLUETOOTH_MODULES=()

		aBLUETOOTH_MODULES=("bluetooth")
		aBLUETOOTH_MODULES+=("bnep")

		aBLUETOOTH_MODULES+=("btbcm") # rpi3 broadcom onboard

		aBLUETOOTH_MODULES+=("rfcomm") # BPi pro
		aBLUETOOTH_MODULES+=("hidp") # BPi pro

		aBLUETOOTH_MODULES+=("hci_uart")

		# - Disable
		if (( ! $STATE )); then

			# + RPi 3
			if (( $HW_MODEL == 3 )); then

				systemctl stop hciuart
				systemctl disable hciuart

			fi

			#bluetooth last
			for ((i=$(( ${#aBLUETOOTH_MODULES[@]} - 1 )); i>=0; i--))
			do

				modprobe -rf "${aBLUETOOTH_MODULES[$i]}" 2> /dev/null
				echo -e "blacklist ${aBLUETOOTH_MODULES[$i]}" >> /etc/modprobe.d/disable_bt.conf

			done

		# - Enable
		else

			#bluetooth first
			for ((i=0; i<${#aBLUETOOTH_MODULES[@]}; i++))
			do

				modprobe "${aBLUETOOTH_MODULES[$i]}" 2> /dev/null

			done

			systemctl enable bluetooth 2> /dev/null
			systemctl start bluetooth 2> /dev/null
			if (( $? != 0 )); then

				/DietPi/dietpi/func/dietpi-notify 2 "Bluetooth service failed to start. Is it installed?"
				EXIT_CODE=1

			fi

			# + RPi 3
			if (( $HW_MODEL == 3 )); then

				systemctl enable hciuart

				#Start service again, if it fails: https://github.com/Fourdee/DietPi/issues/376#issuecomment-230149754
				loop_count=0
				max_count=3
				while (( $(systemctl start hciuart;echo $?) != 0 ))
				do

					if (( $loop_count >= $max_count )); then

						/DietPi/dietpi/func/dietpi-notify 1 "hciuart failed to start after $loop_count attempts."
						EXIT_CODE=1
						break

					else

						/DietPi/dietpi/func/dietpi-notify 2 "hciuart failed to start. Attempting to restart it, please wait..."
						((loop_count++))
						sleep 1

					fi

				done

			fi

		fi

		unset aBLUETOOTH_MODULES

	fi

	#-----------------------------------------------------------------------------------
	/DietPi/dietpi/func/dietpi-notify -1 ${EXIT_CODE:=0} "$STATE_TEXT $ADAPTER |"
	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}
