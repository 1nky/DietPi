#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Function:
	# - Configures core/basic folders/permissions/services etc for DietPi a environment
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Script does not require a DietPi ready system to exec, can be used in PREP_SYSTEM
	# - DietPi sourcecode must exist in /DietPi
	# - Not everything for the DietPi env is contained here, only the core/critial stuff, to prevent dupe code in patches/PREP_SYSTEM
	#
	# Usage:
	# - /boot/dietpi/func/dietpi-set_core_environment
	# - /DietPi/dietpi/func/dietpi-set_core_environment
	#////////////////////////////////////

	#Import DietPi-Globals -------------------------------------------------------------
	. /DietPi/dietpi/func/dietpi-globals
	G_CHECK_ROOT_USER
	export G_PROGRAM_NAME='DietPi-Set_core_environment'
	G_INIT
	#Import DietPi-Globals -------------------------------------------------------------

	#///////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#///////////////////////////////////////////////////////////////////////////////////
	G_DIETPI-NOTIFY 2 'Creating core DietPi environment, please wait...'

	#-----------------------------------------------------------------------------------
	# Bash Profiles

	# - Pre v6.9 cleaning:
	sed -i '/\/DietPi/d' /root/.bashrc
	sed -i '/\/DietPi/d' /home/dietpi/.bashrc &> /dev/null
	rm /etc/profile.d/99-dietpi* &> /dev/null

	# - Enable /etc/bashrc.d/ support for custom interactive non-login shell scripts:
	G_CONFIG_INJECT 'for i in /etc/bashrc\.d/\*\.sh; do \[ -r "\$i" \] \&\& \. \$i; done' 'for i in /etc/bashrc\.d/\*\.sh; do \[ -r "\$i" \] \&\& \. \$i; done' /etc/bash.bashrc

	# - Enable bash-completion for non-login shells:
	#	- NB: It is called twice on login shells then, but breaks directly if called already once.
	ln -sf /etc/profile.d/bash_completion.sh /etc/bashrc.d/dietpi-bash_completion.sh

	#-----------------------------------------------------------------------------------
	#Create_DietPi_User

	G_DIETPI-NOTIFY 2 'Creating DietPi User Account:'

	/DietPi/dietpi/func/dietpi-set_software useradd dietpi

	#-----------------------------------------------------------------------------------
	#UID bit for sudo
	# - https://github.com/Fourdee/DietPi/issues/794

	G_DIETPI-NOTIFY 2 'Configuring Sudo UID bit:'

	chmod 4755 $(which sudo)

	#-----------------------------------------------------------------------------------
	#Dir's

	G_DIETPI-NOTIFY 2 'Configuring DietPi Directories:'

	# - /var/lib/dietpi : Core storage for installed non-standard APT software, outside of /mnt/dietpi_userdata
	#mkdir -p /var/lib/dietpi
	mkdir -p /var/lib/dietpi/postboot.d
	chown dietpi:dietpi /var/lib/dietpi
	chmod 660 /var/lib/dietpi

	#	Storage locations for program specifc additional data
	mkdir -p /var/lib/dietpi/dietpi-autostart
	mkdir -p /var/lib/dietpi/dietpi-config

	#mkdir -p /var/lib/dietpi/dietpi-ramlog
	mkdir -p /var/lib/dietpi/dietpi-ramlog/storage

	#mkdir -p /var/lib/dietpi/dietpi-software
	mkdir -p /var/lib/dietpi/dietpi-software/installed		#Additional storage for installed apps, eg: custom scripts and data

	# - /var/tmp/dietpi : Temp storage saved during reboots, eg: logs outside of /var/log
	mkdir -p /var/tmp/dietpi/logs
	chown dietpi:dietpi /var/tmp/dietpi
	chmod 660 /var/tmp/dietpi

	# - /DietPi RAMdisk
	mkdir -p /DietPi
	chown dietpi:dietpi /DietPi
	chmod 660 /DietPi

	# - /mnt/dietpi_userdata : DietPi userdata
	mkdir -p "$G_FP_DIETPI_USERDATA"
	chown dietpi:dietpi "$G_FP_DIETPI_USERDATA"
	chmod -R 775 "$G_FP_DIETPI_USERDATA"

	# - Networked drives
	mkdir -p /mnt/samba
	mkdir -p /mnt/ftp_client
	mkdir -p /mnt/nfs_client

	#-----------------------------------------------------------------------------------
	#Services

	G_DIETPI-NOTIFY 2 'Configuring DietPi Services:'

	systemctl enable dietpi-ramdisk.service
	systemctl enable dietpi-ramlog.service
	systemctl enable dietpi-boot.service
	systemctl enable dietpi-postboot
	systemctl enable kill-ssh-user-sessions-before-network

	#-----------------------------------------------------------------------------------
	#Cron Jobs

	G_DIETPI-NOTIFY 2 "Configuring Cron:"

	mkdir -p /etc/cron.minutely #: https://github.com/Fourdee/DietPi/pull/1578

	cat << _EOF_ > /etc/crontab
#Please use dietpi-cron to change cron start times
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
*/30 * * * *   root    cd / && run-parts --report /etc/cron.minutely
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 1    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 1    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 1    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
_EOF_

	# - ntp
	rm /etc/cron.daily/ntp &> /dev/null

	#-----------------------------------------------------------------------------------
	#Network

	G_DIETPI-NOTIFY 2 "Configuring: prefer wlan/eth naming for networked devices:"

	# - Prefer to use wlan/eth naming for networked devices (eg: stretch)
	ln -sf /dev/null /etc/systemd/network/99-default.link
	#	x86_64: kernel cmd line with GRUB
	#	HW_ARCH not set at this stage within DietPi, using PREP_SYSTEM
	if [ -f /etc/default/grub ]; then

		sed -i '/^GRUB_CMDLINE_LINUX_DEFAULT=/c\GRUB_CMDLINE_LINUX_DEFAULT="consoleblank=0 quiet"' /etc/default/grub #ipv6.disable=1 # https://github.com/Fourdee/DietPi/pull/1419#issuecomment-360452027
		sed -i '/^GRUB_CMDLINE_LINUX=/c\GRUB_CMDLINE_LINUX="net.ifnames=0"' /etc/default/grub
		sed -i '/^GRUB_TIMEOUT=/c\GRUB_TIMEOUT=0' /etc/default/grub
		update-grub

	fi

	#-----------------------------------------------------------------------------------
	#MISC

	G_DIETPI-NOTIFY 2 "Disabling apt-daily services on Stretch+ (prevents random APT cache lock):"

	if (( $G_DISTRO > 3 )); then

		systemctl disable apt-daily.service &> /dev/null
		systemctl disable apt-daily.timer &> /dev/null
		systemctl disable apt-daily-upgrade.service &> /dev/null
		systemctl disable apt-daily-upgrade.timer &> /dev/null
		systemctl mask apt-daily.service &> /dev/null
		systemctl mask apt-daily.timer &> /dev/null
		systemctl mask apt-daily-upgrade.service &> /dev/null
		systemctl mask apt-daily-upgrade.timer &> /dev/null

	fi

	#-----------------------------------------------------------------------------------
	G_DIETPI-NOTIFY 0 "Completed DietPi core environment"
	exit
	#-----------------------------------------------------------------------------------
}
