#!/bin/bash
{
	#////////////////////////////////////
	# DietPi-Globals
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel.knight@dietpi.com / dietpi.com
	#
	#////////////////////////////////////
	#
	# Info:
	# - Allows export of shared DietPi global variables into current bash session, and, other scripts
	# Notes:
	# - . /DietPi/dietpi/func/dietpi-globals > $HOME/.bashrc
	#////////////////////////////////////

	#Force en_GB Locale for whole script. Prevents incorrect parsing with non-english locales.
	LANG=en_GB.UTF-8

	/DietPi/dietpi/func/dietpi-notify 2 'Updating DietPi-Globals, please wait...'

	#-----------------------------------------------------------------------------------
	# Hardware Details
	#-----------------------------------------------------------------------------------
	#Update
	if [ "$1" = 'update_hw_details' ] ||
		[ ! -f /DietPi/dietpi/.hw_model ]; then

		/DietPi/dietpi/dietpi-obtain_hw_model

	fi

	#Globals
	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	HW_ARCH=$(sed -n 6p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)
	DISTRO_NAME='jessie'
	if (( $DISTRO == 4 )); then

		DISTRO_NAME='stretch'

	elif (( $DISTRO == 5 )); then

		DISTRO_NAME='buster'

	fi
	#HW_CPU_CORES=$(nproc --all)


	#-----------------------------------------------------------------------------------
	# User-Data
	#-----------------------------------------------------------------------------------
	FP_DIETPI_USERDATA_DIRECTORY='/mnt/dietpi_userdata'

	#-----------------------------------------------------------------------------------
	# APT
	#-----------------------------------------------------------------------------------
	FP_LOG_APT='/etc/dietpi/logs/dietpi-software_apt.log'
	EXITCODE_APT=0 #only way I found of exporting the exit code, once the command is run.

	AGI(){

		local string="$@"
		local force_options=''

		if (( $DISTRO >= 4 )); then

			force_options='--allow-downgrades --allow-remove-essential --allow-change-held-packages --allow-unauthenticated'

		else

			force_options='--force-yes'

		fi

		#-qq can add a slight period of appearing nothing is happening, lets inform user
		/DietPi/dietpi/func/dietpi-notify 2 "APT is processing, please wait...\n"
		DEBIAN_FRONTEND=noninteractive apt-get install -y -qq $force_options $string 2>&1 | tee "$FP_LOG_APT"
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#apt-get purge
	AGP(){

		local string="$@"
		if (( $DISTRO >= 4 )); then

			string+=' --allow-change-held-packages'

		fi

		apt-get purge -y $string
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#apt-get autoremove
	AGA(){

		apt-get autoremove --purge -y
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#apt-get install -f
	AGF(){

		DEBIAN_FRONTEND=noninteractive apt-get install -f -y $force_options 2>&1 | tee "$FP_LOG_APT"
		EXITCODE_APT=${PIPESTATUS[0]}

	}

	#-----------------------------------------------------------------------------------
	/DietPi/dietpi/func/dietpi-notify 0 'DietPi-Globals\n'
	#-----------------------------------------------------------------------------------
}
