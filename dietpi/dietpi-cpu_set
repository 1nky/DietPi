#!/bin/bash
{
	#////////////////////////////////////
	# DietPi CPU Gov Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Runs at boot up /DietPi/dietpi/boot
	# - Sets CPU governor | ondemand | powersave | performance etc
	# - Sets CPU governor user prefs | throttle up percent etc
	#////////////////////////////////////

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	CPU_CORES=$(nproc)

	CPU_GOVERNOR=$(cat /DietPi/dietpi.txt | grep 'cpu_governor=' | sed 's/cpu_governor=//g')

	#XU3/4 exit for now
	# - We have to apply the cpu settings to a different path, and, to each quad core set
	#   eg: 1.4ghz set = echo 10000 > /sys/devices/system/cpu/cpu0/cpufreq/ondemand/sampling_rate
	#   eg: 2.0ghz set = echo 10000 > /sys/devices/system/cpu/cpu4/cpufreq/ondemand/sampling_rate
	if (( $HW_MODEL == 11 )); then
		exit
	fi
	
	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	
	#Apply CPU gov
	for ((i=0; i<$CPU_CORES; i++))
	do
		echo "$CPU_GOVERNOR" > /sys/devices/system/cpu/cpu"$i"/cpufreq/scaling_governor
	done

	#Set CPU governor ondemand settings
	if [ "$CPU_GOVERNOR" = ondemand ]; then
	
		CPU_THROTTLE_UP_PERCENT=$(cat /DietPi/dietpi.txt | grep 'cpu_usage_throttle_up' | sed 's/cpu_usage_throttle_up=//g')
		CPU_ONDEMAND_SAMPLING_RATE=$(cat /DietPi/dietpi.txt | grep 'cpu_ondemand_sampling_rate' | sed 's/cpu_ondemand_sampling_rate=//g')
		CPU_ONDEMAND_SAMPLING_DOWN_FACTOR=$(cat /DietPi/dietpi.txt | grep 'cpu_ondemand_sampling_down_factor' | sed 's/cpu_ondemand_sampling_down_factor=//g')

		echo "$CPU_THROTTLE_UP_PERCENT" > /sys/devices/system/cpu/cpufreq/ondemand/up_threshold
		echo "$CPU_ONDEMAND_SAMPLING_RATE" > /sys/devices/system/cpu/cpufreq/ondemand/sampling_rate
		echo "$CPU_ONDEMAND_SAMPLING_DOWN_FACTOR" > /sys/devices/system/cpu/cpufreq/ondemand/sampling_down_factor
		
	#Set CPU governor conservative settings	
	elif [ "$CPU_GOVERNOR" = conservative ]; then
		CPU_THROTTLE_UP_PERCENT=$(cat /DietPi/dietpi.txt | grep 'cpu_usage_throttle_up' | sed 's/cpu_usage_throttle_up=//g')
		echo "$CPU_THROTTLE_UP_PERCENT" > /sys/devices/system/cpu/cpufreq/conservative/up_threshold

	fi

	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}