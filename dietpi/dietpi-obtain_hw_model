#!/bin/bash
{
	#////////////////////////////////////
	# DietPi
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#////////////////////////////////////
	#
	# Info:
	# - Generates /DietPi/dietpi/.hw_model
	# - Called from /DietPi/dietpi/boot
	#
	# - Line1 -
	# HW_MODEL 30 Orange Pi (PC)
	# HW_MODEL 20 VM
	# HW_MODEL 11 oDroid XU3/4
	# HW_MODEL 10 oDroid C1
	# HW_MODEL 2 Raspberry Pi 2 (1024mb)
	# HW_MODEL 1 Raspberry Pi 1 (512mb)
	# HW_MODEL 0 Raspberry Pi 1 (256mb)
	# - Line2 -
	# HW_MODEL_DESCRIPTION
	# - Line3 -
	# DISTRO 0 unknown
	# DISTRO 1 Debian Wheezy
	# DISTRO 2 Ubuntu 14.04 (No longer supported, left in for user message during update)
	# DISTRO 3 Jessie / Ubuntu 15.04
	# - Line4 -
	# RootFS Filepath (eg: /dev/mmc01)
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#Obtain Hardware Model index
	#/////////////////////////////////////////////////////////////////////////////////////

	HW_MODEL=0
	HW_MODEL_DESCRIPTION='Unknown Model'
	FP_HW_MODEL_INDENTIFIER='/etc/.dietpi_hw_model_identifier'

	#Systems that use /etc/.dietpi_hw_model_identifier for HW_MODEL
	if [ -f "$FP_HW_MODEL_INDENTIFIER" ]; then

		HW_MODEL=$(sed -n 1p "$FP_HW_MODEL_INDENTIFIER")

		#OrangePi
		if (( $HW_MODEL == 30 )); then
			HW_MODEL_DESCRIPTION='Orange Pi (PC)'
			STORAGE_ROOT_PATH="/dev/mmcblk0p2"

		#VM
		elif (( $HW_MODEL == 20 )); then
			HW_MODEL_DESCRIPTION='Virtual Machine (x64)'
			STORAGE_ROOT_PATH="/dev/sda1"
		fi

	#oDroid XU3/4
	elif (( $(cat /proc/cpuinfo | grep -ci -m1 'ODROID-XU3') == 1 )); then
		HW_MODEL_DESCRIPTION='oDroid XU3/4'
		HW_MODEL=11
		STORAGE_ROOT_PATH="/dev/mmcblk0p2"
	#oDroid C1
	elif (( $(cat /proc/cpuinfo | grep -ci -m1 'ODROIDC') == 1 )); then
		HW_MODEL_DESCRIPTION='oDroid C1'
		HW_MODEL=10
		STORAGE_ROOT_PATH="/dev/mmcblk0p2"
	#RPi 2
	elif (( $(cat /proc/cpuinfo | grep -ci -m1 'BCM2709') == 1 )); then
		HW_MODEL_DESCRIPTION='Raspberry Pi 2 (1GB)'
		HW_MODEL=2
		STORAGE_ROOT_PATH="/dev/root"
	#Get Pi1 Model IDs by checking total memory size (-10mb, ensures that 256/256 split doesnt come up as Pi 1(256mb) etc)
	elif (( $(free | awk '/^Mem:/{print $2}') > 246000 )); then
		HW_MODEL_DESCRIPTION='Raspberry Pi 1 (512MB)'
		HW_MODEL=1
		STORAGE_ROOT_PATH="/dev/root"
	else
		HW_MODEL_DESCRIPTION='Raspberry Pi 1 (256MB)'
		HW_MODEL=0
		STORAGE_ROOT_PATH="/dev/root"
	fi

	#Get Distro Index (assume wheezy)
	DISTRO=1
	#Ubuntu 14.04
	if (( $( cat /etc/*release | grep -ci -m1 '14.04') == 1 )); then
		DISTRO=2
	#Debian Jessie
	elif (( $( cat /etc/*release | grep -ci -m1 'jessie') == 1 )); then
		DISTRO=3
	fi

	#Clear previous file
	rm /DietPi/dietpi/.hw_model &> /dev/null

	#Save model Index (LINE 1)
	echo -e "$HW_MODEL" >> /DietPi/dietpi/.hw_model

	#Save Description (LINE 2)
	echo -e "$HW_MODEL_DESCRIPTION" >> /DietPi/dietpi/.hw_model

	#Save Distro Index (LINE 3)
	echo -e "$DISTRO" >> /DietPi/dietpi/.hw_model

	#Save RootFS FP (LINE 4)
	echo -e "$STORAGE_ROOT_PATH" >> /DietPi/dietpi/.hw_model
	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}