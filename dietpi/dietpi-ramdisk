#!/bin/bash
{
	#////////////////////////////////////
	# DietPi RAMDISK Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Copies dietpi files from /boot to /DietPi (ram)
	# - /DietPi is mounted as tmpfs (ram)
	# - This allows us to vastly reduce filesystem IO across DietPi.
	#
	# Usage:
	# - Called from /DietPi/dietpi/conf/dietpi-service
	# - /DietPi/dietpi/dietpi-ramdisk 0				= Copy from /boot (disk) to /DietPi (ram)
	# - /DietPi/dietpi/dietpi-ramdisk 1				= Copy from /DietPi (ram) to /boot (disk)
	#////////////////////////////////////
	
	INPUT=0
	
	if [[ $1 =~ ^-?[0-9]+$ ]]; then
		INPUT=$1
	fi

	FILEPATH_RAM="/DietPi"
	FILEPATH_DISK="/boot"
	
	#/////////////////////////////////////////////////////////////////////////////////////
	#Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	
	#Copy to Ram
	if (( $INPUT == 0 )); then

		#Directory
		mkdir -p "$FILEPATH_RAM"/dietpi
		mkdir -p "$FILEPATH_RAM"/dietpi/conf
		mkdir -p "$FILEPATH_RAM"/dietpi/func
		mkdir -p "$FILEPATH_RAM"/dietpi/misc

		#/boot/* files
		cp "$FILEPATH_DISK"/dietpi.txt "$FILEPATH_RAM"/
		cp "$FILEPATH_DISK"/boot.ini "$FILEPATH_RAM"/
		cp "$FILEPATH_DISK"/config.txt "$FILEPATH_RAM"/
		
		#/boot/dietpi folder
		cp -Rf "$FILEPATH_DISK"/dietpi "$FILEPATH_RAM"/

		##remove Conf folder contents.
		#rm -R "$FILEPATH_RAM"/dietpi/conf
		##create symlink to conf folders on disk
		#ln -sf "$FILEPATH_DISK"/dietpi/conf "$FILEPATH_RAM"/dietpi/conf
		
		#Set execute
		chmod -R +x "$FILEPATH_RAM"
	
	#Copy everything back to DISK
	elif (( $INPUT == 1 )); then
	
		#Remove all of DietPi files and folders from DISK
		rm -R "$FILEPATH_DISK"/dietpi
		rm "$FILEPATH_DISK"/dietpi.txt
		rm "$FILEPATH_DISK"/boot.ini
		rm "$FILEPATH_DISK"/config.txt
		
		#Copy DietPi to Disk with files from RAM
		cp -Rf "$FILEPATH_RAM"/* /boot
	fi
	

	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}