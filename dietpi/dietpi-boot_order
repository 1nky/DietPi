#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Boot Order Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - filename /DietPi/dietpi/dietpi-boot_order
	#
	# Usage:
	# - dietpi-boot_order   (menu system)
	# - dietpi-boot_order int (set value only)
	#////////////////////////////////////

	#Grab Input (valid interger)
	INPUT=-1
	if [[ $1 =~ ^-?[0-9]+$ ]]; then
		INPUT=$1
	fi

	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)

	#/////////////////////////////////////////////////////////////////////////////////////
	# MENUS
	#/////////////////////////////////////////////////////////////////////////////////////
	WHIP_BACKTITLE='DietPi AutoBoot'
	WHIP_TITLE='------- DietPi - AutoBoot Preference -------'
	CHOICE=0
	OPTION=0
	TARGETMENUID=0

	AUTO_BOOT_INDEX=0

	Apply_Boot_Index(){

		#Save boot index.
		echo -e "$AUTO_BOOT_INDEX" > /DietPi/dietpi/.auto_boot_index

		#Enable auto login
		if (( $AUTO_BOOT_INDEX > 0 )); then

			#Deb wheezy
			if (( $DISTRO == 1 )); then
				cp /DietPi/dietpi/conf/inittab_desktop /etc/inittab
			#U 14.04
			elif (( $DISTRO == 2 )); then
				sed -i '/exec \/sbin\/getty -8 38400 tty1/c\exec \/sbin\/getty -8 38400 tty1 -a root' /etc/init/tty1.conf
			#jessie
			elif (( $DISTRO == 3 )); then
				mkdir -p /etc/systemd/system/getty@tty1.service.d &> /dev/null
				cat << _EOF_ > /etc/systemd/system/getty@tty1.service.d/autologin.conf
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin root %I
_EOF_
			fi


		#Disable auto login
		else

			#Deb wheezy
			if (( $DISTRO == 1 )); then
				cp /DietPi/dietpi/conf/inittab_server /etc/inittab
			#U 14.04
			elif (( $DISTRO == 2 )); then
				sed -i '/exec \/sbin\/getty -8 38400 tty1/c\exec \/sbin\/getty -8 38400 tty1' /etc/init/tty1.conf
			#jessie
			elif (( $DISTRO == 3 )); then
				rm /etc/hosts/etc/systemd/system/getty@tty1.service.d/autologin.conf &> /dev/null
			fi

		fi
	}

	#TARGETMENUID=0
	Menu_Main(){

		#existing boot flag
		AUTO_BOOT_INDEX=$(cat /DietPi/dietpi/.auto_boot_index)

		local -a option_name=(
			"0" "Console: Manual Login (default)"
			"7" "Console: Automatic Login"
			"1" "Kodi"
			"2" "LXDE: Desktop"
			"6" "LXDE: VNC Server"
			"3" "RetroPie"
			"4" "OpenTyrian"
			"5" "DietPi-Cloudshell"
		)

		OPTION=$(whiptail --title "$WHIP_TITLE" --menu "Current AutoBoot Option: $AUTO_BOOT_INDEX\n\nNB: Please ensure your boot choice is also installed (or selected for install) in dietpi-software." --cancel-button "Back" --backtitle "$WHIP_BACKTITLE" --default-item "$AUTO_BOOT_INDEX" 17 65 6 "${option_name[@]}" 3>&1 1>&2 2>&3)
		CHOICE=$?

		unset option_name

		if (( $CHOICE == 0 )); then

			#Apply Selected boot option
			AUTO_BOOT_INDEX=$OPTION

			Apply_Boot_Index

		else
			#Exit
			TARGETMENUID=-1
		fi

	}


	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Start Menu
	if (( $INPUT == -1 )); then

		while (( $TARGETMENUID > -1 )); do

			#Clear Screen buffer
			clear

			if (( $TARGETMENUID == 0 )); then
				Menu_Main
			fi
		done

	#Apply boot index
	elif (( $INPUT > -1 )); then

		AUTO_BOOT_INDEX=$INPUT
		Apply_Boot_Index

	fi

	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}