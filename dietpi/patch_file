#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#VERSION CODE
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2

	#/////////////////////////////////////////////////////////////////////////////////////
	#Obtain Pi/Odroid Model
	#/////////////////////////////////////////////////////////////////////////////////////

	HW_MODEL=$(sed -n 1p /boot/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /boot/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /boot/dietpi/.hw_model)
	
	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 50 )); then
		echo -e "50 > 51 patch"

		#Desktop - Disable PCMANfm trash can (not installed with dietpi due to gvfs package requirments, bulky)
		if (( $(cat /boot/dietpi/.installed | grep 'DESKTOP' | awk '{print $2}') == 2 )); then
			sed -i '/use_trash=/c\use_trash=0' /etc/xdg/libfm/libfm.conf
			sed -i '/use_trash=/c\use_trash=0' ~/.config/libfm/libfm.conf
		fi
		
	elif (( $VERSION_CURRENT == 51 )); then
		echo -e "51 > 52 patch"
		
		#Remove hardware specific transmission conf files. Unique settings are now applied by dietpi-software using one conf file. 
		rm /boot/dietpi/conf/transmission_settings_*
		
		#Add support for RPi Camera module in DietPi-Config
		if (( $(cat /boot/config.txt | grep -ci -m1 'start_x=') == 0 )); then
			echo -e "\nRPi Camera Module -------- \nstart_x=0" >> /boot/config.txt
		#Already exists. Convert it to the system dietpi-config expects.
		elif (( $(cat /boot/config.txt | grep -ci -m1 '#start_x=') == 1 )); then
			sed -i '/start_x=/c\start_x=0' /boot/config.txt
		fi
		
		#Add support for RPi Camera LED in DietPi-Config
		if (( $(cat /boot/config.txt | grep -ci -m1 'disable_camera_led=') == 0 )); then
			echo -e "disable_camera_led=0" >> /boot/config.txt
		#Already exists. Convert it to the system dietpi-config expects.
		elif (( $(cat /boot/config.txt | grep -ci -m1 '#disable_camera_led=') == 1 )); then
			sed -i '/disable_camera_led=/c\disable_camera_led=0' /boot/config.txt
		fi
		
		#Whoopsie, bad day at the office, lol.
		rm -R /home/twat &> /dev/null
		
	elif (( $VERSION_CURRENT == 52 )); then
		echo -e "52 > 53 patch"
		
	fi

	sleep 2

	#Run whole script inside a function. Loads into memory, allows for online file patching.
	exit
}