#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /DietPi/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#VERSION CODE
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2
	
	#/////////////////////////////////////////////////////////////////////////////////////
	#Obtain Pi/Odroid Model
	#/////////////////////////////////////////////////////////////////////////////////////
	
	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)
	
	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 70 )); then
		echo -e "70 > 71 patch"
		#-------------------------------------------------------------------------------
		#Update DietPi Service
		update-rc.d -f dietpi-service remove
		rm /etc/init.d/dietpi-service
		cp /DietPi/dietpi/conf/dietpi-service /etc/init.d/dietpi-service
		chmod +x /etc/init.d/dietpi-service
		update-rc.d dietpi-service defaults 80 01
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 71 )); then
		echo -e "71 > 72 patch"
		#-------------------------------------------------------------------------------
		#DietPi-Software | Added DietPi optimized installation option for "Grasshopper" (Web App to control Bticino MyHome).
		#-------------------------------------------------------------------------------
		#Update CPU alias
		sed -i "/alias cpu=/c\alias cpu='/DietPi/dietpi/dietpi-cpu_info'" /etc/bash.bashrc
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 72 )); then
		echo -e "72 > 73 patch"
		#-------------------------------------------------------------------------------
		#Patch for DietPicam /root installs (media cannot be located in /root folder)
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep 'DIETPICAM ' | awk '{print $2}') == 2 )) && 
				[ -d /root/dietpicam ]; then

				rm -R /root/dietpicam
				
				mkdir -p /dietpicam
				rm -R /var/www/dietpicam/media
				ln -s /dietpicam /var/www/dietpicam/media
				chown -R www-data:www-data /dietpicam
				chmod -R 777 /dietpicam
			fi
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 73 )); then
		echo -e "73 > 74 patch"
		#-------------------------------------------------------------------------------
		#Force fakeclock to use the current time (this prevents fakeclock from setting the correct time when user changes tzdata)
		sed -i "/FORCE=/c\FORCE=force" /etc/default/fake-hwclock
		#-------------------------------------------------------------------------------
		#Set dietpicam installations to 128mb GPU (for rpi v1 devices).
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep 'DIETPICAM ' | awk '{print $2}') == 2 )); then

				if (( $HW_MODEL == 0 )); then
					gpu_mem_current=$(grep 'gpu_mem_256=' /DietPi/config.txt  | sed 's/gpu_mem_256=//g')
				elif (( $HW_MODEL == 1 )); then
					gpu_mem_current=$(grep 'gpu_mem_512=' /DietPi/config.txt  | sed 's/gpu_mem_512=//g')
				elif (( $HW_MODEL == 2 )); then
					gpu_mem_current=$(grep 'gpu_mem_1024=' /DietPi/config.txt  | sed 's/gpu_mem_1024=//g')
				fi
				
				if (( $gpu_mem_current < 128 )); then
					sed -i '/gpu_mem_256=/c\gpu_mem_256=128' /DietPi/config.txt
					sed -i '/gpu_mem_512=/c\gpu_mem_512=128' /DietPi/config.txt
					sed -i '/gpu_mem_1024=/c\gpu_mem_1024=128' /DietPi/config.txt
				fi
			fi
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 74 )); then
		echo -e "74 > 75 patch"
		#-------------------------------------------------------------------------------
		#Update DietPi Service
		update-rc.d -f dietpi-service remove
		rm /etc/init.d/dietpi-service
		cp /DietPi/dietpi/conf/dietpi-service /etc/init.d/dietpi-service
		chmod +x /etc/init.d/dietpi-service
		update-rc.d dietpi-service defaults 00 80
		#-------------------------------------------------------------------------------
		#Removal of ramlog
		apt-get purge ramlog -y
		apt-get autoremove --purge -y
		
		TEMP_VAR="rsync"
		echo -e "\nDietPi: Testing $TEMP_VAR for safe removal\n"
		if (( $(echo -e "n\n" | apt-get purge "$TEMP_VAR" | grep -ci -m1 ' 1 to remove ') == 1 )); then
			apt-get purge "$TEMP_VAR" -y
		fi

		TEMP_VAR="lsof"
		echo -e "\nDietPi: Testing $TEMP_VAR for safe removal\n"
		if (( $(echo -e "n\n" | apt-get purge "$TEMP_VAR" | grep -ci -m1 ' 1 to remove ') == 1 )); then
			apt-get purge "$TEMP_VAR" -y
		fi
		#-------------------------------------------------------------------------------
		#Add new tmpfs /var/log to FStab (to replace ramlog)
		if (( $(cat /etc/fstab | grep -ci -m1 '/var/log') == 0 )); then
			if (( $(dpkg -l | grep -ci -m1 'ramlog') == 1 )); then
				sed -i '/DietPi/a tmpfs                   /var/log                tmpfs   size=10m,noatime,nodev,nosuid,mode=1777  0 0' /etc/fstab
			else
				sed -i '/DietPi/a #/var/log DietPi Ramlog Disabled' /etc/fstab
			fi
		fi
		#-------------------------------------------------------------------------------

	fi

		#-------------------------------------------------------------------------------
		# If we need to apt-get anything, wait for apt-get update thread to finish.
		#/DietPi/dietpi/dietpi-apt-get_update 1
		#-------------------------------------------------------------------------------
	sleep 1
	#-------------------------------------------------------------------------------
	exit
	#-------------------------------------------------------------------------------
}