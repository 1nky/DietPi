#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /DietPi/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#VERSION CODE
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2
	
	#/////////////////////////////////////////////////////////////////////////////////////
	#Obtain Pi/Odroid Model
	#/////////////////////////////////////////////////////////////////////////////////////
	
	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)
	
	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 70 )); then
		echo -e "70 > 71 patch"
		#-------------------------------------------------------------------------------
		#Update DietPi Service
		update-rc.d -f dietpi-service remove
		rm /etc/init.d/dietpi-service
		cp /DietPi/dietpi/conf/dietpi-service /etc/init.d/dietpi-service
		chmod +x /etc/init.d/dietpi-service
		update-rc.d dietpi-service defaults 80 01
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 71 )); then
		echo -e "71 > 72 patch"
		#-------------------------------------------------------------------------------
		#DietPi-Software | Added DietPi optimized installation option for "Grasshopper" (Web App to control Bticino MyHome).
		#-------------------------------------------------------------------------------
		#Update CPU alias
		sed -i "/alias cpu=/c\alias cpu='/DietPi/dietpi/dietpi-cpu_info'" /etc/bash.bashrc
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 72 )); then
		echo -e "72 > 73 patch"
		#-------------------------------------------------------------------------------
		#Patch for DietPicam /root installs (media cannot be located in /root folder)
		if (( $(cat /DietPi/dietpi/.installed | grep 'DIETPICAM ' | awk '{print $2}') == 2 )); then
			if [ -d /root/dietpicam ]; then
				rm -R /root/dietpicam
				
				mkdir -p /dietpicam
				rm -R /var/www/dietpicam/media
				ln -s /dietpicam /var/www/dietpicam/media
				chown -R www-data:www-data /dietpicam
				chmod -R 777 /dietpicam
			fi
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 73 )); then
		echo -e "73 > 74 patch"
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------

	fi

		#-------------------------------------------------------------------------------
		# If we need to apt-get anything, wait for apt-get update thread to finish.
		#/DietPi/dietpi/dietpi-apt-get_update 1
		#-------------------------------------------------------------------------------
	sleep 1
	#-------------------------------------------------------------------------------
	exit
	#-------------------------------------------------------------------------------
}