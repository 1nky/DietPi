#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /boot/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#VERSION CODE
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2

	#/////////////////////////////////////////////////////////////////////////////////////
	#Obtain Pi/Odroid Model
	#/////////////////////////////////////////////////////////////////////////////////////

	HW_MODEL=$(sed -n 1p /boot/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /boot/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /boot/dietpi/.hw_model)
	
	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 50 )); then
		echo -e "50 > 51 patch"

		#Desktop - Disable PCMANfm trash can (not installed with dietpi due to gvfs package requirments, bulky)
		if (( $(cat /boot/dietpi/.installed | grep 'DESKTOP' | awk '{print $2}') == 2 )); then
			sed -i '/use_trash=/c\use_trash=0' /etc/xdg/libfm/libfm.conf
			sed -i '/use_trash=/c\use_trash=0' ~/.config/libfm/libfm.conf
		fi
		
	elif (( $VERSION_CURRENT == 51 )); then
		echo -e "51 > 52 patch"
		
		#Remove hardware specific transmission conf files. Unique settings are now applied by dietpi-software using one conf file. 
		rm /boot/dietpi/conf/transmission_settings_*
		
		#Add support for RPi Camera module in DietPi-Config
		if (( $(cat /boot/config.txt | grep -ci -m1 'start_x=') == 0 )); then
			echo -e "\nRPi Camera Module -------- \nstart_x=0" >> /boot/config.txt
		#Already exists. Convert it to the system dietpi-config expects.
		elif (( $(cat /boot/config.txt | grep -ci -m1 '#start_x=') == 1 )); then
			sed -i '/start_x=/c\start_x=0' /boot/config.txt
		fi
		
		#Add support for RPi Camera LED in DietPi-Config
		if (( $(cat /boot/config.txt | grep -ci -m1 'disable_camera_led=') == 0 )); then
			echo -e "disable_camera_led=0" >> /boot/config.txt
		#Already exists. Convert it to the system dietpi-config expects.
		elif (( $(cat /boot/config.txt | grep -ci -m1 '#disable_camera_led=') == 1 )); then
			sed -i '/disable_camera_led=/c\disable_camera_led=0' /boot/config.txt
		fi
		
	elif (( $VERSION_CURRENT == 52 )); then
		echo -e "52 > 53 patch"
		
		#EOL updates for installed init scripts.
		if (( $(cat /boot/dietpi/.installed | grep 'YMPD' | awk '{print $2}') == 2 )); then
			cp /boot/dietpi/conf/ympd_init /etc/init.d/ympd
			chmod +x /etc/init.d/ympd
			update-rc.d ympd defaults
		fi
		
		if (( $(cat /boot/dietpi/.installed | grep 'VPNSERVER' | awk '{print $2}') == 2 )); then
			cp /boot/dietpi/conf/vpnserver_init /etc/init.d/vpnserver 
			chmod +x /etc/init.d/vpnserver
			update-rc.d vpnserver defaults
		fi
		
		#EOL updates for installed run scripts.
		if (( $(cat /boot/dietpi/.installed | grep 'OPENTYRIAN' | awk '{print $2}') == 2 )); then
			cp /boot/dietpi/conf/opentyrian_run /usr/local/games/opentyrian/run
			chmod +x /usr/local/games/opentyrian/run
		fi
		
	elif (( $VERSION_CURRENT == 53 )); then
		echo -e "53 > 54 patch"
		
		#WEBSERVER install flag has changed to split system. patch host .installed file.
		if [ -f /boot/dietpi/.installed ]; then

			#Get current installed state value
			temp_value=$(cat /boot/dietpi/.installed | grep 'WEBSERVER' | awk '{print $2}')
			
			#Change WEBSERVER to WEBSERVER_LAMP
			sed -i "/WEBSERVER/c\WEBSERVER_LAMP $temp_value" /boot/dietpi/.installed
			
			#echo new webserver installation splits to /boot/dietpi/.installed
			echo -e "WEBSERVER_APACHE $temp_value" >> /boot/dietpi/.installed
			echo -e "WEBSERVER_PHP $temp_value" >> /boot/dietpi/.installed
			echo -e "WEBSERVER_MYSQL $temp_value" >> /boot/dietpi/.installed
			echo -e "WEBSERVER_PHPMYADMIN $temp_value" >> /boot/dietpi/.installed
		fi
		
		#/boot/dietpi/conf/index.php has changed to phpinfo.php. Allows us to reserve index.php for other software.
		#Apply to hostsystem
		if [ -f /var/www/index.php ]; then
			#Check its our file
			if (( $(cat /var/www/index.php | grep -ci -m1 'phpinfo()') == 1 )); then
				rm /var/www/index.php
				cp /boot/dietpi/conf/phpinfo.php /var/www/phpinfo.php
			fi
		fi
		#Remove the old index.php from boot partition /dietpi/conf/
		rm /boot/dietpi/conf/index.php
		
	fi

	sleep 2

	#Run whole script inside a function. Loads into memory, allows for online file patching.
	exit
}