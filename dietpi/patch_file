#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /DietPi/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)

	#/////////////////////////////////////////////////////////////////////////////////////
	# Func
	#/////////////////////////////////////////////////////////////////////////////////////
	#new software installation for dietpi-software. Update to users .installed file
	DietPi_Software_Addition(){

		#DietPi_Software_Addition STRING INT
		#							|	  |
		#							|	  Installed state (0, 2=installed)
		#							Name

		local input_string="$1"
		local input_value=$2

		#Has installed file
		if [ -f /DietPi/dietpi/.installed ]; then

			#Check for previous entry
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 "$input_string " ) == 0 )); then

				#Add new entry
				echo -e "$input_string $input_value" >> /DietPi/dietpi/.installed

			fi

		fi
	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 101 )); then
		echo -e "101 > 102 patch"
		#-------------------------------------------------------------------------------
		#C1 - missing Dbus.
		if (( $HW_MODEL == 10 )); then
			/DietPi/dietpi/dietpi-apt-get_update 1
			apt-get install dbus -y
		fi
		#-------------------------------------------------------------------------------
		#Cleanups
		rm -R /root/.vim &> /dev/null
		rm -R /root/.config/mc &> /dev/null
		#-------------------------------------------------------------------------------
		#Cron - NTPD hourly/daily
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'ntpd_update_mode=') == 0 )); then
			sed -i '/dietpi_check_for_updates=/a #NTPD Update Mode: 0=disabled | 1=boot only | 2=boot + daily | 3=boot + hourly | 4=Daemon + Drift.\nntpd_update_mode=2' /DietPi/dietpi.txt
		fi
		cp /DietPi/dietpi/conf/cron.daily_dietpi /etc/cron.daily/dietpi
		chmod +x /etc/cron.daily/dietpi
		cp /DietPi/dietpi/conf/cron.hourly_dietpi /etc/cron.hourly/dietpi
		chmod +x /etc/cron.hourly/dietpi
		#-------------------------------------------------------------------------------
		#Updated crontab
		cat << _EOF_ > /etc/crontab
#Please use dietpi-config > advanced > Set cron start times
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user  command
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 1    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 1    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 1    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
_EOF_
		#-------------------------------------------------------------------------------
		#Alias
		# - Add DietPi-Launcher
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-launcher=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-launcher='/DietPi/dietpi/dietpi-launcher'" /etc/bash.bashrc
		fi
		# - Update dietpi-uninstall alias
		sed -i "/alias dietpi-uninstall=/c\alias dietpi-uninstall='/DietPi/dietpi/dietpi-uninstall'" /etc/bash.bashrc
		# - Update CPU info
		sed -i "/alias cpu=/c\alias cpu='/DietPi/dietpi/dietpi-cpuinfo'" /etc/bash.bashrc
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 102 )); then
		echo -e "102 > 103 patch"
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------

	fi

		#-------------------------------------------------------------------------------
		# If we need to apt-get anything, wait for apt-get update thread to finish.
		#/DietPi/dietpi/dietpi-apt-get_update 1

		#New dietpi-software additions
		#DietPi_Software_Addition SOFTWARENAME 0
		#-------------------------------------------------------------------------------

	#-------------------------------------------------------------------------------
	sleep 0.25
	#-------------------------------------------------------------------------------
	exit
	#-------------------------------------------------------------------------------
}