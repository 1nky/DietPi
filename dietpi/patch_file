#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Daniel Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /DietPi/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)

	#/////////////////////////////////////////////////////////////////////////////////////
	# Func
	#/////////////////////////////////////////////////////////////////////////////////////
	#new software installation for dietpi-software. Update to users .installed file
	DietPi_Software_Addition(){

		#DietPi_Software_Addition STRING INT
		#							|	  |
		#							|	  Installed state (0, 2=installed)
		#							Name

		local input_string="$1"
		local input_value=$2

		#Has installed file
		if [ -f /DietPi/dietpi/.installed ]; then

			#Check for previous entry
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 "$input_string " ) == 0 )); then

				#Add new entry
				echo -e "$input_string $input_value" >> /DietPi/dietpi/.installed

			fi

		fi
	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 102 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		DietPi_Software_Addition LETSENCRYPT 0
		DietPi_Software_Addition WIRINGPI 0
		#-------------------------------------------------------------------------------
		#DNS fixes for STATIC. We MUST supply DNS servers if using STATIC, else /etc/resolv.conf will be empty.
		# - Update curret network details
		/DietPi/dietpi/func/obtain_network_details
		# - Add missing disabled dns-nameservers to wlan.
		sed -i "/wpa-psk /a #dns-nameservers 8.8.8.8 8.8.4.4" /etc/network/interfaces
		# - If static IP is currently in use, enable google dns-nameservers.
		active_network_adapter=$(sed -n 3p /DietPi/dietpi/.network)
		if (( $( cat /etc/network/interfaces | grep -ci -m1 "iface $active_network_adapter inet static") == 1 )); then
			sed -i 's/^#dns-nameservers/dns-nameservers/g' /etc/network/interfaces
		fi
		# - Delete 'Uncomment for Google DNS servers reference'
		sed -i '/Uncomment for Google/d' /etc/network/interfaces
		# - Add DNS entry to dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'Static_DNS=') == 0 )); then
			sed -i "/Static_Gateway=/a Static_DNS=8.8.8.8" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Missing Resolvconf
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install resolvconf -y
		#-------------------------------------------------------------------------------
		#New Bash Alias's
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-autostart=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-autostart='/DietPi/dietpi/dietpi-autostart'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-affinity=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-affinity='/DietPi/dietpi/dietpi-affinity'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-letsencrypt=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-letsencrypt='/DietPi/dietpi/dietpi-letsencrypt'" /etc/bash.bashrc
		fi
		# - DietPi-Cloudshell input cli changes
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cloudshell=') == 1 )); then
			sed -i '/alias dietpi-cloudshell=/d' /etc/bash.bashrc &> /dev/null
			sed -i "/#DietPi Additions/a alias dietpi-cloudshell='/DietPi/dietpi/dietpi-cloudshell'" /etc/bash.bashrc
		fi
		#-------------------------------------------------------------------------------
		#NTPD drift file ownership must match user that NTPD runs as, or it wont write to drift file (even though its ran as root.......)
		chown root:root /var/lib/ntp/ntp.drift
		#-------------------------------------------------------------------------------
		#Information change for crontab (DietPi-Cron instead of dietpi-config)
		sed -i '/#Please use dietpi-config/c\#Please use DietPi-Cron to change cron start times' /etc/crontab &> /dev/null
		#-------------------------------------------------------------------------------
		#Proftpd patch | to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change
		if [ -f /etc/proftpd/proftpd.conf ]; then
			if (( $(cat /etc/proftpd/proftpd.conf | grep -ci -m1 'WtmpLog') == 0 )); then
				sed -i "/SystemLog /a #to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change\nWtmpLog off" /etc/proftpd/proftpd.conf
			fi
		fi
		#-------------------------------------------------------------------------------


	elif (( $VERSION_CURRENT == 103 )); then
		#-------------------------------------------------------------------------------
		# New automation/misc options > dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^AUTO_AutoLogin=') == 0 )); then
			sed -i "/# >> Automation Options/a #Automatically logs the root user in to start 1st run setup.\nAUTO_AutoLogin=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Hostname=') == 0 )); then
			sed -i "/# >> Automation Options/a Hostname=DietPi" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^Swapfile_Size=') == 0 )); then
			sed -i "/# >> Automation Options/a Swapfile_Size=100" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#FP name change for autoboot (now DietPi-Autostart)
		mv /DietPi/dietpi/.auto_boot_index /DietPi/dietpi/.dietpi-autostart_index
		#-------------------------------------------------------------------------------
		#DietPi-Cloudshell - 'c / 'f option / Target output
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '4s/.*/1/' /DietPi/dietpi/.dietpi-cloudshell
			sed -i '5s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell
		fi
		#-------------------------------------------------------------------------------
		#dphys-swapfile - add location to conf
		if (( $(cat /etc/dphys-swapfile | grep -ci -m1 '^CONF_SWAPFILE=') == 0 )); then
			echo -e "CONF_SWAPFILE=/var/swap" >> /etc/dphys-swapfile
		fi
		#-------------------------------------------------------------------------------
		#PiHole Update
		if [ -f /usr/local/bin/gravity.sh ]; then
			#remove old lists (we need to regenerate)
			rm /etc/pihole/list.*
			rm /etc/pihole/pihole.*
			rm /etc/pihole/gravity.list

			cp /DietPi/dietpi/conf/pihole_gravity /usr/local/bin/gravity.sh
			chmod +x /usr/local/bin/gravity.sh
			/usr/local/bin/gravity.sh
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 104 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		DietPi_Software_Addition WIFIHOTSPOT 0
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WIFIHOTSPOT=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WIFIHOTSPOT=0" /DietPi/dietpi.txt
		fi

		#-------------------------------------------------------------------------------
		#dietpi-cleaner alias missing from bashrc
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cleaner=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-cleaner='/DietPi/dietpi/dietpi-cleaner'" /etc/bash.bashrc
		fi
		#-------------------------------------------------------------------------------
		#Updated hw_model script - Generate unique system ID
		rm /DietPi/dietpi/.hw_model &> /dev/null
		/DietPi/dietpi/dietpi-obtain_hw_model
		#-------------------------------------------------------------------------------
		#Wifi Hotspot settings
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_ssid=') == 0 )); then
			sed -i "/ntpd_update_mode=/a\ \n#Wifi Hotspot\nwifi_hotspot_ssid=DietPi-HotSpot\n# - minimum of 8 characters\nwifi_hotspot_key=dietpihotspot\nwifi_hotspot_channel=3" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 105 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		DietPi_Software_Addition SHAIRPORTSYNC 0
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_SHAIRPORTSYNC=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_SHAIRPORTSYNC=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#dbus-x11 now installed by default with xserver installations. Required for ibus, fcitx etc. inputs.
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'XSERVERXORG 2') == 1 )); then
				/DietPi/dietpi/dietpi-apt-get_update 1
				apt-get install dbus-x11 -y
			fi
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 106 )); then
		#-------------------------------------------------------------------------------
		# DietPi-Process Tool
		# -  bash alias add dietpi-process_control
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-process_tool=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-process_tool='/DietPi/dietpi/dietpi-process_tool'" /etc/bash.bashrc
		fi
		# - bash alias, remove nice/affinity
		sed -i '/dietpi-nice/d' /etc/bash.bashrc
		sed -i '/dietpi-affinity/d' /etc/bash.bashrc
		#remove .dietpi-nice .dietpi-affinity settings
		rm /DietPi/dietpi/.dietpi-nice
		rm /DietPi/dietpi/.dietpi-affinity
		#-------------------------------------------------------------------------------
		#Prompt user regarding nice/affinity changes
		if [ -f /DietPi/dietpi/.installed ]; then
			whiptail --title "Info: DietPi-Process_Tool" --msgbox "DietPi-Affinity and DietPi-Nice has now been replaced by DietPi-Process_Tool.\n\nIf you have used these programs in the past, you will need to reapply your nice and affinity settings by running the following command, after you reboot the system.\n\ndietpi-process_tool" 14 70
		fi
		#-------------------------------------------------------------------------------
		#Enable IPv6 for all DietPi images by default
		rm /etc/modprobe.d/blacklist-ipv6.conf &> /dev/null
		sed -i "/net.ipv6.conf.all.disable_ipv6 /c\net.ipv6.conf.all.disable_ipv6 = 0" /etc/sysctl.conf
		sed -i "/net.ipv6.conf.default.disable_ipv6 /c\net.ipv6.conf.default.disable_ipv6 = 0" /etc/sysctl.conf
		sed -i "/net.ipv6.conf.lo.disable_ipv6 /c\net.ipv6.conf.lo.disable_ipv6 = 0" /etc/sysctl.conf
		#Update /etc/hosts with ipv6
		if (( $(cat /etc/hosts | grep -ci -m1 'ip6-localhost') == 0 )); then
			cat << _EOF_ >> /etc/hosts
::1             localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		DietPi_Software_Addition BRUTEFIR 0
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_BRUTEFIR=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_BRUTEFIR=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 107 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		DietPi_Software_Addition PYDIO 0
		DietPi_Software_Addition SQUEEZELITE 0
		# - automation add option
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_PYDIO=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_PYDIO=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_SQUEEZELITE=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_SQUEEZELITE=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#DESKTOP_LXDE dietpi-nice > dietpi-process_tool
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE 2') == 1 )); then
				rm /usr/share/applications/dietpi-nice.desktop
				ln -sf /DietPi/dietpi/conf/desktop/dietpi-process_tool.desktop /usr/share/applications/dietpi-process_tool.desktop
			fi
		fi
		#-------------------------------------------------------------------------------
	elif (( $VERSION_CURRENT == 108 )); then
		#-------------------------------------------------------------------------------
		#Pydrio: Impossible write into the AJXP_DATA_PATH folder https://github.com/Fourdee/DietPi/issues/186
		chown -R www-data:www-data /pydio_data &> /dev/null
		chown -R www-data:www-data /mnt/usb_1/pydio_data &> /dev/null
		#-------------------------------------------------------------------------------
		#PiHole webstats patch https://github.com/Fourdee/DietPi/issues/187#issue-131328814
		if [ -f /usr/local/bin/gravity.sh ]; then
			wget https://raw.githubusercontent.com/pi-hole/pi-hole/master/advanced/Scripts/chronometer.sh -O /usr/local/bin/chronometer.sh
			chmod +x /usr/local/bin/chronometer.sh

			/DietPi/dietpi/dietpi-apt-get_update 1
			apt-get install -y bc
		fi
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		# - Lighttpd
		DietPi_Software_Addition WEBSERVER_LIGHTTPD 0
		DietPi_Software_Addition WEBSERVER_LLMP 0
		DietPi_Software_Addition WEBSERVER_LLSP 0
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLMP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLMP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLSP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLSP=0" /DietPi/dietpi.txt
		fi

		# - MariaDB
		DietPi_Software_Addition WEBSERVER_MARIADB 0
		DietPi_Software_Addition WEBSERVER_LAAP 0
		DietPi_Software_Addition WEBSERVER_LEAP 0
		DietPi_Software_Addition WEBSERVER_LLAP 0
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LAAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LAAP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LEAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LEAP=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_LLAP=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_LLAP=0" /DietPi/dietpi.txt
		fi

		#-------------------------------------------------------------------------------
		#Disable powersaving for 8188eu wifi chipsets
		echo -e "options 8188eu rtw_power_mgnt=0" > /etc/modprobe.d/8188eu.conf
		#-------------------------------------------------------------------------------
		#debconf-get-selections mising from odroid's
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install -y debconf-utils
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 109 )); then
		#-------------------------------------------------------------------------------
		#Put XU4 kernel updates on hold to prevent automated installations causing broken kernel/modules.
		#https://github.com/Fourdee/DietPi/issues/185#issuecomment-183343474
		if (( $HW_MODEL == 11 )); then
			apt-mark hold linux-headers-armhf-odroid-xu3 linux-image-armhf-odroid-xu3
		fi
		#-------------------------------------------------------------------------------
		#LXDE desktop, remove dietpi-nice.desktop links, add dietpi-process_tool
		if [ -f /DietPi/dietpi/.installed ]; then
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 'DESKTOP_LXDE 2') == 1 )); then
				rm /usr/share/applications/dietpi-nice.desktop
				ln -sf /DietPi/dietpi/conf/desktop/dietpi-process_tool.desktop /usr/share/applications/dietpi-process_tool.desktop
			fi
		fi
		#-------------------------------------------------------------------------------
		#DietPi.txt | new option to override user/personal data target directory in DietPi-Software: https://github.com/Fourdee/DietPi/issues/198
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_userdata_basedirectory=') == 0 )); then
			sed -i "/wifi_hotspot_channel=/a #------------------------------------------------------------------------------------------------------\n# D I E T - P I\n# DietPi-Software settings.\n#------------------------------------------------------------------------------------------------------\n#Override target directory for user/personal data.\n#This is applied to software configurations when installing software (eg: owncloud, bittorrent downloads etc).\n#  Auto = Automatic (default). If USB dedicated drive was setup /mnt/usb_1, else, /root\n#  /mnt/Where/I/Want/My/Data = Example\n#  /mnt/user_data = Example\ndietpi_userdata_basedirectory=Auto\n" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Updated network details script , rerun
		/DietPi/dietpi/func/obtain_network_details
		#-------------------------------------------------------------------------------
		#BC is now installed by default on all DietPi systems. bc is needed for bash floating point calculations that many scripts rely on.
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install -y bc
		#-------------------------------------------------------------------------------
		#Cloudshell new option | NETWORK_USAGE_CURRENT_OUTPUT_TYPE
		if [ -f /DietPi/dietpi/.dietpi-cloudshell ]; then
			sed -i '6s/.*/0/' /DietPi/dietpi/.dietpi-cloudshell
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 110 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		# - Oracle Java 8 jdk
		DietPi_Software_Addition ORACLEJAVA 0
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_ORACLEJAVA=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_FFMPEG=/a AUTO_DietpiSoftware_Install_ORACLEJAVA=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#RPI Jessie:
		# - remove /etc/apt/sources.list.d/collabora.list. This was left over from Wheezy dist-upgrade and is not required.
		# - Update /etc/apt/sources.list.d/raspi.list to match Raspbian Jessie raspi.list.
		if (( $HW_MODEL < 10 )) && (( $DISTRO == 3 )); then
			rm /etc/apt/sources.list.d/collabora.list
			cat << _EOF_ > /etc/apt/sources.list.d/raspi.list
deb http://archive.raspberrypi.org/debian/ jessie main ui
# Uncomment line below then 'apt-get update' to enable 'apt-get source'
#deb-src http://archive.raspberrypi.org/debian/ jessie main ui
_EOF_
			/DietPi/dietpi/dietpi-apt-get_update 2
		fi
		#-------------------------------------------------------------------------------
		#RPI - snd-bcm2835 is now disabled by default.
		if (( $HW_MODEL < 10 )) && (( $(dpkg -l | grep -ci -m1 'alsa') == 0 )); then
			/DietPi/dietpi/func/dietpi-set_soundcard none
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 111 )); then
		#-------------------------------------------------------------------------------
		#RPi 3 - WiFi hotspot. Internal Wifi fix.
		# - Disable driver definition
		# - Use non-modified hostapd binary from Jessie repo.
		if (( $HW_MODEL == 3 )) && (( $(dpkg -l | grep -ci -m1 'hostapd') == 1 )); then
			apt-get remove hostapd -y
			apt-get install hostapd -y
			sed -i '/driver=/c\#driver=rtl871xdrv/' /etc/hostapd/hostapd.conf
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 112 )); then
		#-------------------------------------------------------------------------------
		#/DietPi/dietpi/dietpi-apt-get_update 1 is now called in dietpi-update, before this patch file is launched.
		# - Run it now for previous DietPi versions. As dietpi-update is loaded into memory, it wont be updated until a reboot.
		/DietPi/dietpi/dietpi-apt-get_update 1
		#-------------------------------------------------------------------------------
		#New location for dietpi-software installed "non-service" based control scripts
		mkdir -p /etc/dietpi/dietpi-software/services

		# - move to new location, if installed
		mv /etc/deluge_init /etc/dietpi/dietpi-software/services/deluge.service &> /dev/null
		mv /etc/raspimjpeg_init /etc/dietpi/dietpi-software/services/raspimjpeg.service &> /dev/null
		mv /etc/squeezeboxserver_init /etc/dietpi/dietpi-software/services/squeezeboxserver.service &> /dev/null
		mv /etc/BruteFIR/brutefir.service /etc/dietpi/dietpi-software/services/brutefir.service &> /dev/null
		chmod -R +x /etc/dietpi/dietpi-software/services
		#-------------------------------------------------------------------------------
		#DietPi-Software additions:
		DietPi_Software_Addition WEBSERVER_REDIS 0
		DietPi_Software_Addition EMONHUB 0
		DietPi_Software_Addition EMONCMS 0
		DietPi_Software_Addition NODEJS 0
		DietPi_Software_Addition RPIMONITOR 0
		DietPi_Software_Addition BAIKAL 0
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_WEBSERVER_REDIS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WEBSERVER_MYADMINPHP=/a AUTO_DietpiSoftware_Install_WEBSERVER_REDIS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_EMONHUB=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_EMONHUB=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_EMONCMS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_EMONCMS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_NODEJS=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_BUILDESSENTIAL=/a AUTO_DietpiSoftware_Install_NODEJS=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_RPIMONITOR=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_RPIMONITOR=0" /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_BAIKAL=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_SQUEEZELITE=/a AUTO_DietpiSoftware_Install_BAIKAL=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#PiHole webstats update
		if [ -f /var/www/pihole/index.php ]; then
			cd ~/
			rm -R /var/www/pihole/*
			wget https://github.com/Fourdee/AdminLTE/archive/master.zip -O package.zip
			unzip package.zip
			rm package.zip
			mv AdminLTE*/* /var/www/pihole/
			rm -R AdminLTE*
		fi
		#-------------------------------------------------------------------------------
		#RPi Jessie DietPi v111 image missing ipv6 in hosts. Add if it doesnt exist
		if (( $(cat /etc/hosts | grep -ci -m1 'ip6-localhost') == 0 )); then
			cat << _EOF_ >> /etc/hosts
::1				localhost ip6-localhost ip6-loopback
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
_EOF_
		fi
		#-------------------------------------------------------------------------------
		#Odroid C2 - Kodi sound fix
		if (( $HW_MODEL == 12 )); then
			if (( $(dpkg -l | grep -ci -m1 'kodi-odroid') == 1 )); then

				# - upgrade kodi
				apt-get update
				apt-get upgrade -y

				# - Remove pulse audio workaround fix we used.
				apt-get purge pulseaudio -y
				apt-get autoremove --purge -y

				# - Asound.conf by Oversun.
				cat << _EOF_ > /etc/asound.conf
pcm.!default {
	type plug
	slave {
		pcm "hw:0,0"
		format S32_LE
	}
}
_EOF_
			fi
		fi
		#-------------------------------------------------------------------------------
		#fbset now installed by default
		apt-get install -y fbset
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 113 )); then
		#-------------------------------------------------------------------------------
		#DietPi-Software Additions
		DietPi_Software_Addition TORHOTSPOT 0
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_Install_TORHOTSPOT=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_Install_WIFIHOTSPOT=/a AUTO_DietpiSoftware_Install_TORHOTSPOT=0" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		# New dietpi-software options > dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^dietpi_emonhub_apikey=') == 0 )); then
			sed -i "/dietpi_userdata_basedirectory=/a #Enter your EmonCMS.org write API key here. It will be applied automatically during EmonPi/Hub installation.\n# - eg: dietpi_emonhub_apikey=b4dfmk2o203mmxx93a\ndietpi_emonhub_apikey=" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#C1 - Ondemand does not work, replace with interactive: https://github.com/Fourdee/DietPi/issues/248
		if (( $HW_MODEL == 10 )) && (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^cpu_governor=ondemand') == 1 )); then
			sed -i "/cpu_governor=/c\cpu_governor=interactive" /DietPi/dietpi.txt
			/DietPi/dietpi/dietpi-cpu_set
		fi
		#-------------------------------------------------------------------------------
		#RPi | Enable max usb current by default
		sed -i '/max_usb_current=/c\max_usb_current=1' /DietPi/config.txt
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 114 )); then
		#-------------------------------------------------------------------------------
		#OPi PC -  Comminuty Fix vcore/freq: https://github.com/Fourdee/DietPi/issues/263
		if (( $HW_MODEL == 30 )); then

			# - Warn user of OPi-PC only support after this is run.
			whiptail --title "OPi-PC vcore/stability fix" --yesno "This will apply the community vcore/stability fix on your system. The fix resolves known issues with the H3 clockspeeds and vcore voltages. Whilst this patch has been tested on OPi-PC systems, there is no guarantee the fix will work, and, could render your system unbootable.\n\nNB: If you NOT using an OPi-PC, say no.\n\nDo you wish to apply the community H3 patch?" --backtitle "DietPi-Update" --defaultno 16 70
			CHOICE=$?
			if (( $CHOICE == 0 )); then
				wget http://dietpi.com/downloads/misc/community/h3_fix_vcore_clock.sh -O patch
				chmod +x patch
				./patch
				rm patch
			fi

		fi
		#-------------------------------------------------------------------------------
		#Webserver preference system
		# - update .installed file with new options.
		if [ -f /DietPi/dietpi/.installed ]; then

			index=-2 #lighttpd

			if (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'apache2') )); then
				index=0
			elif (( $(dpkg -l | awk '{print $2}' | grep -ci -m1 'nginx') )); then
				index=-1
			fi

			cat << _EOF_ >> /DietPi/dietpi/.installed
#DietPi Preference System: Webserver base
INDEX_WEBSERVER_CURRENT $index
INDEX_WEBSERVER_TARGET $index
_EOF_

		fi

		# - Add automation support for Webserver preference to dietpi.txt.
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'AUTO_DietpiSoftware_WebserverIndex=') == 0 )); then
			sed -i "/AUTO_DietpiSoftware_LoggingIndex=/a #Webserver Preference Selection:\n# NB: This will get ignored, if you have manually selected any WEBSERVER_Stacks.\n#    0=Apache2\n#    -1=Nginx\n#    -2=Lighttpd\nAUTO_DietpiSoftware_WebserverIndex=-2" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		# Possible missing dietpi.txt global vars for < v109 images. Add them if required.
		# - To prevent this from occuring again:
		#	For AUTO_ entries, use sed to insert at specific line
		#	For global VARs, just echo the value to the end of dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_ssid=') == 0 )); then
			echo -e "wifi_hotspot_ssid=DietPi-HotSpot" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_key=') == 0 )); then
			echo -e "wifi_hotspot_key=dietpihotspot" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'wifi_hotspot_channel=') == 0 )); then
			echo -e "wifi_hotspot_channel=3" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_userdata_basedirectory=') == 0 )); then
			echo -e "dietpi_userdata_basedirectory=Auto" >> /DietPi/dietpi.txt
		fi
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'dietpi_emonhub_apikey=') == 0 )); then
			echo -e "dietpi_emonhub_apikey=" >> /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------

	elif (( $VERSION_CURRENT == 115 )); then
		#-------------------------------------------------------------------------------
		# + DietPi.txt Proxy settings
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 '^proxy_address=') == 0 )); then
			cat << _EOF_ >> /DietPi/dietpi.txt
#Proxy settings | set proxy_enabled to 1 and enter proxy details. This will be applied system wide.
proxy_enabled=0
proxy_address=MyProxyServer.com
proxy_port=1234
proxy_username=
proxy_password=
_EOF_
		fi
		#-------------------------------------------------------------------------------

	fi

		#-------------------------------------------------------------------------------
		#New dietpi-software additions
		#DietPi_Software_Addition SOFTWARENAME 0
		#NB: all if statements must contain at least one command. Prevents bash error.
		#-------------------------------------------------------------------------------

	#-------------------------------------------------------------------------------
	sleep 0.25
	#-------------------------------------------------------------------------------
	exit
	#-------------------------------------------------------------------------------
}