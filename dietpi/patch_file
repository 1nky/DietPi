#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Patch File Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	#////////////////////////////////////
	#
	# Info:
	# - Online patching for hosts filesystem.
	# - Runs from dietpi-update
	#
	# Usage:
	# - /DietPi/dietpi/patch_file iCurrentVersion iServerVersion
	#////////////////////////////////////

	#/////////////////////////////////////////////////////////////////////////////////////
	#Globals
	#/////////////////////////////////////////////////////////////////////////////////////
	VERSION_CURRENT=$1
	VERSION_SERVER=$2

	HW_MODEL=$(sed -n 1p /DietPi/dietpi/.hw_model)
	HW_MODEL_DESCRIPTION=$(sed -n 2p /DietPi/dietpi/.hw_model)
	DISTRO=$(sed -n 3p /DietPi/dietpi/.hw_model)

	#/////////////////////////////////////////////////////////////////////////////////////
	# Func
	#/////////////////////////////////////////////////////////////////////////////////////
	#new software installation for dietpi-software. Update to users .installed file
	DietPi_Software_Addition(){

		#DietPi_Software_Addition STRING INT
		#							|	  |
		#							|	  Installed state (0, 2=installed)
		#							Name

		local input_string="$1"
		local input_value=$2

		#Has installed file
		if [ -f /DietPi/dietpi/.installed ]; then

			#Check for previous entry
			if (( $(cat /DietPi/dietpi/.installed | grep -ci -m1 "$input_string " ) == 0 )); then

				#Add new entry
				echo -e "$input_string $input_value" >> /DietPi/dietpi/.installed

			fi

		fi
	}

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main Loop
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "Patching $VERSION_CURRENT to $VERSION_SERVER"

	if (( $VERSION_CURRENT == 102 )); then
		echo -e "102 > 103 patch"
		#-------------------------------------------------------------------------------
		#DietPi-Software additions
		DietPi_Software_Addition LETSENCRYPT 0
		DietPi_Software_Addition WIRINGPI 0
		#-------------------------------------------------------------------------------
		#DNS fixes for STATIC. We MUST supply DNS servers if using STATIC, else /etc/resolv.conf will be empty.
		# - Update curret network details
		/DietPi/dietpi/func/obtain_network_details
		# - Add missing disabled dns-nameservers to wlan.
		sed -i "/wpa-psk /a #dns-nameservers 8.8.8.8 8.8.4.4" /etc/network/interfaces
		# - If static IP is currently in use, enable google dns-nameservers.
		active_network_adapter=$(sed -n 3p /DietPi/dietpi/.network)
		if (( $( cat /etc/network/interfaces | grep -ci -m1 "iface $active_network_adapter inet static") == 1 )); then
			sed -i 's/^#dns-nameservers/dns-nameservers/g' /etc/network/interfaces
		fi
		# - Delete 'Uncomment for Google DNS servers reference'
		sed -i '/Uncomment for Google/d' /etc/network/interfaces
		# - Add DNS entry to dietpi.txt
		if (( $(cat /DietPi/dietpi.txt | grep -ci -m1 'Static_DNS=') == 0 )); then
			sed -i "/Static_Gateway=/a Static_DNS=8.8.8.8" /DietPi/dietpi.txt
		fi
		#-------------------------------------------------------------------------------
		#Missing Resolvconf
		/DietPi/dietpi/dietpi-apt-get_update 1
		apt-get install resolvconf -y
		#-------------------------------------------------------------------------------
		#New Bash Alias's
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-autostart=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-autostart='/DietPi/dietpi/dietpi-autostart'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-affinity=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-affinity='/DietPi/dietpi/dietpi-affinity'" /etc/bash.bashrc
		fi

		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-letsencrypt=') == 0 )); then
			sed -i "/#DietPi Additions/a alias dietpi-letsencrypt='/DietPi/dietpi/dietpi-letsencrypt'" /etc/bash.bashrc
		fi
		# - DietPi-Cloudshell input cli changes
		if (( $(cat /etc/bash.bashrc | grep -ci -m1 'dietpi-cloudshell=') == 1 )); then
			sed -i '/alias dietpi-cloudshell=/d' /etc/bash.bashrc &> /dev/null
			sed -i "/#DietPi Additions/a alias dietpi-cloudshell='/DietPi/dietpi/dietpi-cloudshell'" /etc/bash.bashrc
		fi
		#-------------------------------------------------------------------------------
		#NTPD drift file ownership must match user that NTPD runs as, or it wont write to drift file (even though its ran as root.......)
		chown root:root /var/lib/ntp/ntp.drift
		#-------------------------------------------------------------------------------
		#Information change for crontab (DietPi-Cron instead of dietpi-config)
		sed -i '/#Please use dietpi-config/c\#Please use DietPi-Cron to change cron start times' /etc/crontab &> /dev/null
		#-------------------------------------------------------------------------------
		#Proftpd patch | to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change
		if [ -f /etc/proftpd/proftpd.conf ]; then
			if (( $(cat /etc/proftpd/proftpd.conf | grep -ci -m1 'WtmpLog') == 0 )); then
				sed -i "/SystemLog /a #to stop logging wtmp /var/log/wtmp: No such file or directory -Gordon Williams change\nWtmpLog off" /etc/proftpd/proftpd.conf
			fi
		fi
		#-------------------------------------------------------------------------------


	elif (( $VERSION_CURRENT == 103 )); then
		echo -e "103 > 104 patch"
		#-------------------------------------------------------------------------------
		#-------------------------------------------------------------------------------

	fi

		#-------------------------------------------------------------------------------
		# If we need to apt-get anything, wait for apt-get update thread to finish.
		#/DietPi/dietpi/dietpi-apt-get_update 1

		#New dietpi-software additions
		#DietPi_Software_Addition SOFTWARENAME 0
		#-------------------------------------------------------------------------------

	#-------------------------------------------------------------------------------
	sleep 0.25
	#-------------------------------------------------------------------------------
	exit
	#-------------------------------------------------------------------------------
}