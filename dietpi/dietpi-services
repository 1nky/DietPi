#!/bin/bash
{
	#////////////////////////////////////
	# DietPi Services Script
	#
	#////////////////////////////////////
	# Created by Dan Knight / daniel_haze@hotmail.com / fuzon.co.uk
	#
	# Info:
	# - Allows service control for all listed programs used in dietpi-software
	# - Disable removes the autostart from init.d. This allows DietPi to control startup services.
	#
	# Usage:
	# - Called from rc.local
	# - /DietPi/dietpi/dietpi-services start/stop/restart/disable
	#////////////////////////////////////

	aSERVICES=(
		"cron"
		"transmission-daemon"
		"proftpd"
		"samba"
		"vsftpd"
		"apache2"
		"nginx"
		"mysql"
		"php5-fpm"
		"mpd"
		"ympd"
		"minidlna"
		"noip2"
		"vpnserver"
		"grasshopper"
		"dnsmasq"
		"subsonic"
		"webiopi"
		"haproxy"
	)

	FP_TEMP="/tmp/.dietpi-services_installed"

	#/////////////////////////////////////////////////////////////////////////////////////
	# Main
	#/////////////////////////////////////////////////////////////////////////////////////
	#Info
	echo -e "\n DietPi-Services"
	echo -e " Mode: $1"
	echo -e " Please wait......"

	#Find installed services
	dpkg --get-selections > "$FP_TEMP"

	#disable
	if [ "$1" = "disable" ]; then
		for ((i=0; i<${#aSERVICES[@]}; i++))
		do
			if (( $(grep -ci -m1 "${aSERVICES[$i]}" "$FP_TEMP") == 1 )); then
				update-rc.d -f ${aSERVICES[$i]} disable &> /dev/null

				#+Jessie(SystemD)
				systemctl disable ${aSERVICES[$i]} &> /dev/null
			fi

		done

		echo -e " Completed"

	#start/stop/restart
	else

		for ((i=0; i<${#aSERVICES[@]}; i++))
		do
			if (( $(grep -ci -m1 "${aSERVICES[$i]}" "$FP_TEMP") == 1 )); then
				service ${aSERVICES[$i]} $1 &> /dev/null
			fi
		done

		#Non-service based control for specific software
		/etc/raspimjpeg_init $1 &> /dev/null
		/etc/deluge_init $1 &> /dev/null
		/etc/squeezeboxserver_init $1 &> /dev/null

		echo -e " Completed"

		#Set Nice
		if [ "$1" = "start" ] ||
			[ "$1" = "restart" ]; then
			echo -e "\n DietPi-Nice\n Applying nice levels....."
			/DietPi/dietpi/dietpi-nice 1
			echo -e " Completed\n"
		fi

	fi

	#-----------------------------------------------------------------------------------
	rm "$FP_TEMP"
	unset aSERVICES
	#-----------------------------------------------------------------------------------
	exit
	#-----------------------------------------------------------------------------------
}